// This is your Prisma schema file,  
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GuestStatus {
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  COMPLETED
  EXPIRED
  REJECTED
}

enum AccessCredentialType {
  QR_CODE
  TEMP_CARD
  FACE
}

enum Role {
  SUPER_ADMIN
  ORG_ADMIN
  BRANCH_MANAGER
  EMPLOYEE
}

enum DeviceType {
  CAMERA
  CARD_READER
  FINGERPRINT
  ANPR
  OTHER
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  DEGRADED
  ERROR
}

enum AttendanceEventType {
  CHECK_IN
  CHECK_OUT
  GUEST_CHECK_IN
  GUEST_CHECK_OUT
  MANUAL_ENTRY
}

// 1. Core organization model  
model Organization {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       OrganizationUser[]
  branches    Branch[]
  employees   Employee[]
  devices     Device[]
  guestVisits GuestVisit[]
  auditLogs   AuditLog[]
}

// 2. Users and their roles  
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  fullName     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organizationLinks OrganizationUser[]
  auditLogs         AuditLog[]
}

model OrganizationUser {
  id             String       @id @default(uuid())
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  role           Role

  // This link shows which branch(es) this user manages  
  managedBranches ManagedBranch[]

  createdAt DateTime @default(now())

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

// 3. Organization branches (locations)  
model Branch {
  id             String       @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  name           String
  address        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  departments Department[]
  employees   Employee[]
  devices     Device[]
  guestVisits GuestVisit[]

  // This link shows which manager(s) manage this branch  
  managers ManagedBranch[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

// 3.1. Many-to-many join table between Manager and Branch  
model ManagedBranch {
  id         String           @id @default(uuid())
  manager    OrganizationUser @relation(fields: [managerId], references: [id], onDelete: Cascade)
  managerId  String
  branch     Branch           @relation(fields: [branchId], references: [id], onDelete: Cascade)
  branchId   String
  assignedAt DateTime         @default(now())

  @@unique([managerId, branchId])
  @@index([managerId])
  @@index([branchId])
}

// 4. Departments within a branch  
model Department {
  id       String       @id @default(uuid())
  branch   Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  branchId String
  name     String
  parentId String? // For internal hierarchy (self-relation)  
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Department[] @relation("DepartmentHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employees Employee[]

  @@unique([branchId, name])
  @@index([branchId])
}

// 5. Employees  
model Employee {
  id             String       @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  branch         Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  branchId       String
  department     Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  departmentId   String?

  firstName    String
  lastName     String
  employeeCode String // Must be unique within the organization  
  email        String? @unique
  phone        String?
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendances Attendance[]

  @@unique([organizationId, employeeCode])
  @@index([organizationId])
  @@index([branchId])
  @@index([departmentId])
}

// 6. Devices  
model Device {
  id             String       @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  branch         Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  branchId       String

  name       String
  type       DeviceType
  ipAddress  String?
  macAddress String?      @unique
  model      String?
  status     DeviceStatus @default(ONLINE)
  lastSeenAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events      DeviceEventLog[]
  attendances Attendance[]

  @@unique([organizationId, name])
  @@index([branchId, status])
}

// 7. Guest visits  
model GuestVisit {
  id             String       @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  branch         Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  branchId       String

  guestName             String
  guestContact          String?
  responsibleEmployeeId String? // Employee.id  

  scheduledEntryTime DateTime
  scheduledExitTime  DateTime

  status               GuestStatus          @default(PENDING_APPROVAL)
  accessCredentialType AccessCredentialType
  accessCredentialHash String? // Hashed value for QR code or temporary card  

  createdByUserId String // User.id  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  attendances Attendance[]

  @@index([branchId, status])
  @@index([accessCredentialHash])
}

// 8. Attendance  
model Attendance {
  id             String @id @default(uuid())
  organizationId String
  branchId       String

  employee   Employee?   @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  employeeId String?
  guestVisit GuestVisit? @relation(fields: [guestId], references: [id], onDelete: SetNull)
  guestId    String?
  device     Device?     @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  deviceId   String?

  eventType AttendanceEventType
  timestamp DateTime            @default(now())
  meta      Json? // Additional information (e.g., temperature)  

  createdAt DateTime @default(now())

  @@index([organizationId, employeeId, timestamp])
  @@index([organizationId, guestId, timestamp])
}

// 9. Events and Audit logs  
model DeviceEventLog {
  id             String @id @default(uuid())
  organizationId String
  deviceId       String
  device         Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  eventType     String // e.g., "face.scan", "card.read"  
  timestamp     DateTime
  rawPayloadUrl String? // Reference to the raw data in S3/MinIO  
  metadata      Json? // Processed data  
  isProcessed   Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([organizationId, deviceId, timestamp])
}

model AuditLog {
  id             String        @id @default(uuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  action   String // e.g.: "CREATE_EMPLOYEE"  
  entity   String // "Employee"  
  entityId String?
  oldValue Json?
  newValue Json?

  createdAt DateTime @default(now())

  @@index([organizationId, userId, createdAt])
}
